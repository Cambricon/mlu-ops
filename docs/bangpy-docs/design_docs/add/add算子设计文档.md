# BANGPy Add 算子开发设计方案

- #### 文档基本信息

| 算子名称     | Add              |
| ----------- | -------------- |
| 编制人/日期  | UniqueSquirrel/2021-12-28 |
| 审批人/日期  |              |

- #### 修改记录

| 修订人           | 修订日期    | 修订描述 |
| --------------- | ---------- | ------- |
| UniqueSquirrel  | 2020-12-28 | 首次提交 |

- #### 内容描述

本文档为 `Add` 算子的设计文档，包括需求分析、接口设计、方案设计、性能优化记录和方案实施部分。

## 1 需求分析

### 1.1 算子需求分析

| 算子功能简介               | 将两个buffer中的数据相加                   |
| ------------------------ | ----------------------------------------|
| 需求来源                  | 为bangpy-ops提供算子demo                  |
| 应用网络                  | ResNet等                                 |
| 输入数据类型               | half, float                             |
| 输入 Shape                | input1: [ length ]; input2: [ length ]  |
| 输入 Layout               | input1: ARRAY; input2: ARRAY            |
| 输出数据类型               | half, float                              |
| 输出 Shape                | [ length ]                               |
| 输出 Layout               | ARRAY                                    |

### 1.2 算子功能和应用场景描述

功能：将输入的两个长度及数据类型相同的buffer内的数据依次相加，输出相加结果

例如：buffer_A = [1 ,2 ,3], buffer_B = [4, 5, 6], add(buffer_A, buffer_B) == [5, 7, 9]

应用场景：ResNet等

### 1.3 算子输入输出参数要求

| 参数    | 语义                  | 类型（输入/输出）| 支持类型     | 物理布局 | 规模限制      |
| ------ | --------------------- | ------------- | ----------- | ------ | -------- |
| input1 | 输入的形状为一维的buffer | 输入           | half, float | ARRAY  | 数据总数 * 数据类型字节数 需要能被 1024 * 4 整除            |
| input2 | 输入的形状为一维的buffer | 输入           | half, float | ARRAY  | 数据总数 * 数据类型字节数 需要能被 1024 * 4 整除            |
| length | 输入的buffer的数据总量   | 输入           | int32       | \      | 数据总数 * buffer数据类型字节数 需要能被 1024 * 4 整除      |
| output | 输出的形状为一维的buffer | 输出           | half, float | ARRAY  | 无       |

### 1.4 算子限制

| 限制类型      | 详细说明                 |
| ------------ | ----------------------- |
| 数据类型限制   | input 和 output 必须同时为同一数据类型  |
| 布局限制      | 仅支持ARRAY的layout |
| 规模限制      | 数据总数 * 数据类型字节数 需要能被 1024 * 4 整除 |

### 1.5 验收标准

#### 1.5.1 精度验收标准

本算子属于 `算术` 类算子，验收标准为 diff3=0。

#### 1.5.2 性能验收标准

待定。

## 2 算子接口设计

### 2.1 参考接口

- TensorFlow

```python
tf.math.add(x, y, name=None)
```

### 2.2 接口设计

```python
MluOpAdd(input1, input2, output)
```

## 3 实现方案设计

### 3.1 实现方案

在nram中开辟三个大小为 `1024 * 数据类型字节数` 的buffer分别用来存放两个输入buffer的数据及输出的结果，从gdram循环拷贝 `1024 * 数据类型字节数` 大小的数据至nram相应的buffer中，然后进行加法计算，循环的次数为输入buffer长度在进行多核拆分后除以nram buffer长度的值。

### 3.2 伪代码实现

```python
memcpy(input1_n, input1, single_buffer_size)
memcpy(input2_n, input2, single_buffer_size)
add(output_n, input1_n ,input2_n)
memcpy(output, output_n, single_buffer_size)
```

### 3.3 拆分(任务拆分，多核拆分)

采用的tasktype固定为UNION1，数据拆分到4个核内计算。

### 3.4 性能优化设计

仅作为算子demo，暂不使用自动流水及其他性能优化项。

### 3.5 可维护性设计

添加变量及函数的相关注释，代码风格遵守PEP8编码规范，支持的target有220、270、290、370。

### 3.6 测试用例设计

- 算子在测试时使用的规模：
  (2048), (4096), (6144)

### 3.7 算子防呆检查

除host端自动生成的部分参数防呆检查外，暂不需要进行其他的防呆检查。

## 4 算子性能优化记录

### 4.1 当前存在问题的规模说明

| 提交日期  | 问题规模 | 问题描述 | 是否已修复 |
| --------- | -------- | -------- | ---------- |
|           |          |          |            |

### 4.2 已经过优化的规模说明

| 提交日期  | 修复规模 | 修复问题 |
| --------- | -------- | -------- |
|           |          |          |

## 5 方案实施

### 5.1 开发测试计划

2021.12.28 算子入库

### 5.2 风险分析

暂无。