# BANGPy LogAddExp 算子开发设计方案

- #### 文档基本信息

| 算子名称   | LogAddExp         |
|--------|-------------------|
| 编制人/日期 | SS7D631/2022-5-18 |
| 审批人/日期 |                   |

- #### 修改记录

| 修订人     | 修订日期      | 修订描述 |
|---------|-----------|------|
| SS7D631 | 2022-5-18 | 首次提交 |  

- #### 内容描述

本文档为 `LogAddExp` 算子的设计文档，包括需求分析、接口设计、方案设计、性能优化记录和方案实施部分。

## 1 需求分析

### 1.1 算子需求分析

| 算子功能简介 | 输入的幂和的对数。                                         |
|--------|---------------------------------------------------|
| 需求来源   | 为bangpy-ops提供算子demo                               |  
| 应用网络   |                                                   |
| 输入数据类型 | float,half                                            |
| 输入     | input1,input2:ARRAY     两张量满足广播条件 |
| 输出数据类型 | 与输入数据类型一致                                             |
| 输出     | out:Array    shape为输入的公共形状                        |


### 1.2 算子功能和应用场景描述

功能：计算 log(exp(x1) + exp(x2))

data_x = [  
    [  
      -744.38378411,  
      32.08532465,   
      259.21401044  
    ],    
    [     
      -65.55983881,  
      -783.89169849,  
      692.46914092  
    ]  
]  
data_y = [  
    205.4972709,  
    -982.95625446,  
    731.07663893  
]  
logaddexp(data_x,data_y) == [  
    [  
        205.49727,  
        32.085323,  
        731.07666  
    ],      
    [      
        205.49727,  
        -783.8917,  
        731.07666  
    ]  
]



### 1.3 算子输入输出参数要求

| 参数     | 语义                      | 类型（输入/输出） | 支持类型  | 物理布局  | 规模限制 |
|--------|-------------------------|-----------|-------|-------|------|
| input1 | 输入的任意shape的buffer       | 输入        | float,half | ARRAY | 无    |
| input2 | 输入的任意shape的buffer       | 输入        | float,half | ARRAY | 无    |
| output | 与输入最小公共shape一致的输出buffer | 输出        | float,half | ARRAY | 无    |

### 1.4 算子限制

| 限制类型   | 详细说明                        |
|--------|-----------------------------|
| 数据类型限制 | input1,input2 和 output 必须同时为同一数据类型 |
| 布局限制   | 仅支持ARRAY的layout             |
| 规模限制   | 无                           |

### 1.5 验收标准

#### 1.5.1 精度验收标准

本算子属于 `算术` 类算子，验收标准为 diff3=0。   

#### 1.5.2 性能验收标准

待定。

## 2 算子接口设计

### 2.1 参考接口

- torch
[torch.logaddexp文档](https://pytorch.org/docs/stable/generated/torch.logaddexp.html?highlight=logaddexp#torch.logaddexp)
```python
torch.logaddexp(input1,input2)
```

### 2.2 接口设计

```python
logaddexp(input1, input2, output)
```

## 3 实现方案设计

### 3.1 实现方案
1 将数据分拆，平均分配到多核。
2 在nram上开辟两块内存，用于存放tensor1和tensor2的数据。
3 每个核执行以下操作：从gram中拷贝数据到本地，计算logaddexp结果。
4 计算完毕，将数据拷贝回gram。
5 将gram中数据，拷贝回cpu。

### 3.2 伪代码实现

```python

memcpy(nram_tensor1, gram_tensor1[start:end])
memcpy(nram_tensor2, gram_tensor2[start:end])
subtract(nram_tensor2, nram_tensor1, nram_tensor2)
exp(nram_tensor2, nram_tensor2)
add(nram_tensor2, nram_tensor2, 1)
log(nram_tensor2, nram_tensor2)
add(nram_tensor2, nram_buffer_in0, nram_tensor2)

memcpy(output[start:end], nram_tensor2)

```
### 3.3 拆分(任务拆分，多核拆分)

使用当前设备的所有核心，并尽可能的将数据均摊到各核。计算公式近似为：数据总量 /（cluster数量*每个cluster的核心数）。

### 3.4 性能优化设计

尽可能将数据分摊至各核
计算均采用向量api

### 3.5 可维护性设计

添加变量及函数的相关注释，代码风格遵守PEP8编码规范。


### 3.6 测试用例设计

- 算子在测试时使用的规模：
  固定测试规模0元素、单个元素、两个元素，128字节对齐，128字节对齐边界，片上nram空间满占用，片上nram空间满占用边界。
  通过shape随机生成函数，生成若干二维及以上shape并随机将input2的规模随机成input1的子集,以测试不同规模的计算。
  并通过bangpy提供得测试接口比较每次计算后cpu计算结果和mlu结算结果得误差是否在精度得误差范围内。

### 3.7 算子防呆检查    
| 测试点            | 验收标准 | 测试结果（出错信息） |
|----------------|------|------------|
| 输入两个张量shape不匹配 | 正常报错 | 通过         |


## 4 算子性能优化记录

### 4.1 当前存在问题的规模说明

| 提交日期 | 问题规模 | 问题描述 | 是否已修复 |
|------|------|------|-------|
|      |      |      |       |

### 4.2 已经过优化的规模说明

| 提交日期 | 修复规模 | 修复问题 |
|------|------|------|
|      |      |      |

## 5 方案实施

### 5.1 开发测试计划

2022.4.30 算子入库   

### 5.2 风险分析

暂无。
