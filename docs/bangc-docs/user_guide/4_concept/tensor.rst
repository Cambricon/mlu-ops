.. _tensor:

张量
========

张量，具有统一数据类型的多维数组。

张量描述符，描述所指向的张量具体信息的载体，包含了张量数据的数据布局、数据类型、维度个数、维度大小、步长大小等信息。通过张量描述符的表征，每一块张量数据才得以具有实际的语义信息，进而可以用来表示图像、语音或视频等各领域的数据。

张量描述符的信息如下：

- 数据布局：表示没有维度语义的array，或者具有维度语义的布局，如NCHW，NHWC，HWCN，NDHWC，NCDHW。Cambricon CNNL使用 ``cnnlTensorLayout_t`` 来描述数据布局。
- 数据类型：表示张量中数据的类型，如half，float，int8，int16等。Cambricon CNNL使用 ``cnnlDataType_t`` 来描述数据类型。
- 维度个数：针对数据布局为array的张量，表示张量的维度，Cambricon CNNL支持1-8维。
- 维度大小：表示每个维度的大小。
- 步长大小：表示在同一个维度中访问两个相邻元素时需要走过的步数。举例：我们定义一个[3,4]的二维矩阵matrix，默认情况下其具有隐含的步长信息数组[4,1]，隐含着用户访问矩阵同维度内相邻元素需要间隔的元素个数信息，步长数组[4,1]的1表示访问第二个维度相邻元素时（例如matrix[2][1]和matrix[2][2]之间），内存上的间隔是0，也就是步长为1；访问第一个维度相邻元素时（例如matrix[1][1]和matrix[2][1]之间），内存上的间隔是3，也就是步长为4。用户可以在Cambricon CNNL提供的张量描述符的相关接口中显示地、灵活地配置步长数组，来对真实张量数据进行灵活地操作。                                  

每一个Cambricon CNNL算子，维度大小一般是可变的，用户可以在调用对应接口之前通过 ``cnnlSetTensorDescriptor()`` 或 ``cnnlSetTensorDescriptorEx()`` 来设置张量信息。其中调用接口 ``cnnlSetTensorDescriptor()`` 时会自动设置张量的步长大小。如果要设置特殊的步长大小，可以调用 ``cnnlSetTensorDescriptorEx()`` 接口。另外，为了减少多次接口调用的时间开销，我们为用户提供了group接口 ``cnnlCreateGroupTensorDescriptors`` ， ``cnnlSetGroupTensorDescriptors`` 和 ``cnnlDestroyGroupTensorDescriptors`` ，用户可以在一次接口调用中完成一组张量描述符的创建、设置与销毁。详情查看《Cambricon CNNL Developer Guide》。

CNNL函数库目前与张量描述符相关的接口有如下几个类别：

- 普通张量描述符相关接口：对张量描述符的普通操作，例如创建、设置、获取、销毁，重置以及设置片上数据类型、量化参数等信息。用户可以从接口名字上显而易见地了解其含义，这里不在赘述。
- Group张量描述符相关接口：对一组张量描述符的普通操作，例如一组张量描述符的创建、设置和销毁。该接口旨在为同时大量创建、设置和销毁一组张量描述的使用场景提供简单易用且高性能的接口。通常来说，该接口的性能收益来自两个部分：一、一次接口调用代替了原先的多次接口调用，减少了接口调用的开销。二、该接口内剔除了一些繁琐的检查操作，例如剔除了检查这一组描述符指针中是否有NULL，剔除了张量设置时候的最大维度限制检查。用户应当小心使用这一组接口，我们建议用户在保证了功能开发正确后，进行极致地性能调优的时候可以考虑使用该组接口。
- Seq张量描述符相关接口：对序列张量描述符的一系列操作，例如创建、设置、获取和销毁，以及为描述符设置量化参数Position和Scale。序列张量是一种特殊的张量，经常用于自然语言处理领域。除去普通张量所包含的信息以外，它还包含了序列的个数、每个序列的长度，以及序列的填补区域（当实际序列长度小于最大序列长度时）需要写入的值等特殊信息。
- Set张量描述符相关接口：对集合张量描述符的一系列操作，例如创建、设置和销毁，以及为集合中的一个张量描述符进行一系列的初始化、设置相关参数等操作。Set接口具有特有描述符 ``cnnlTensorSetDescriptor_t`` 。目前我们建议用户仅在调用RNN相关算子，例如  ``cnnlRNNForwardInference`` ， ``cnnlInitRNNExtraInput``  时使用该接口。

各个接口的分类以及简介，可以参照下表：

.. tabularcolumns:: |m{0.55\textwidth}|m{0.2\textwidth}|m{0.15\textwidth}|
.. table:: 张量描述符相关接口功能

    +----------------------------------------------------+--------------------------------+-----------------------------+
    |接口名字                                            |接口功能                        |注意事项                     |
    +====================================================+================================+=============================+
    |普通张量描述符相关接口                                                                                             |
    +----------------------------------------------------+--------------------------------+-----------------------------+
    |cnnlCreateTensorDescriptor                          |创建一个张量描述符              |无                           |
    +----------------------------------------------------+--------------------------------+-----------------------------+
    |cnnlSetTensorDescriptor                             |为一个张量描述符设置信息        |Position、Scale、Offset等不变|
    +----------------------------------------------------+--------------------------------+-----------------------------+
    |cnnlGetTensorDescriptor                             |获取一个张量描述符信息          |无                           |
    +----------------------------------------------------+--------------------------------+-----------------------------+
    |cnnlDestroyTensorDescriptor                         |销毁一个张量描述符              |无                           |
    +----------------------------------------------------+--------------------------------+-----------------------------+
    |cnnlResetTensorDescriptor                           |重置一个张量描述符的所有信息    |Position、Scale、Offset等也会|
    |                                                    |                                |被重置                       |
    +----------------------------------------------------+--------------------------------+-----------------------------+
    |cnnlSetTensorDescriptorEx                           |为一个张量描述符设置信息        |可以设置 Stride 信息         |
    +----------------------------------------------------+--------------------------------+-----------------------------+
    |cnnlGetTensorDescriptorEx                           |获取一个张量描述符的信息        |可以获取 Stride 信息         |
    +----------------------------------------------------+--------------------------------+-----------------------------+
    |cnnlSetTensorDescriptorOnchipDataType               |为一个张量描述符设置片上数据类  |无                           |
    |                                                    |型信息                          |                             |
    +----------------------------------------------------+--------------------------------+-----------------------------+
    |cnnlGetTensorDescriptorOnchipDataType               |获取一个张量描述符的片上数据类  |无                           |
    |                                                    |型信息                          |                             |
    +----------------------------------------------------+--------------------------------+-----------------------------+
    |cnnlSetTensorDescriptorPosition                     |为一个张量描述符设置量化参数    |无                           |
    |                                                    |Position                        |                             |
    +----------------------------------------------------+--------------------------------+-----------------------------+
    |cnnlGetTensorDescriptorPosition                     |获取一个张量描述符的量化参数    |无                           |
    |                                                    |Position                        |                             |
    +----------------------------------------------------+--------------------------------+-----------------------------+
    |cnnlSetTensorDescriptorPositionAndScale             |为一个张量描述符设置量化参数    |无                           |
    |                                                    |Position 与 Scale               |                             |
    +----------------------------------------------------+--------------------------------+-----------------------------+
    |cnnlGetTensorDescriptorPositionAndScale             |获取一个张量描述符的量化参数    |无                           |
    |                                                    |Position 与 Scale               |                             |
    +----------------------------------------------------+--------------------------------+-----------------------------+
    |cnnlSetTensorDescriptorPositionScaleAndOffset       |为一个张量描述符设置量化参数    |无                           |
    |                                                    |Position，Scale 与 Offset       |                             |
    +----------------------------------------------------+--------------------------------+-----------------------------+
    |cnnlGetTensorDescriptorPositionScaleAndOffset       |获取一个张量描述符的量化参数    |无                           |
    |                                                    |Position，Scale 与 Offset       |                             |
    +----------------------------------------------------+--------------------------------+-----------------------------+
    |Group 张量描述符相关接口                                                                                           |
    +----------------------------------------------------+--------------------------------+-----------------------------+
    |cnnlCreateGroupTensorDescriptors                    |创建一组张量描述符              |无                           |
    +----------------------------------------------------+--------------------------------+-----------------------------+
    |cnnlSetGroupTensorDescriptors                       |为一组张量描述符设置信息        |无                           |
    +----------------------------------------------------+--------------------------------+-----------------------------+
    |cnnlDestroyGroupTensorDescriptors                   |销毁一组张量描述符              |无                           |
    +----------------------------------------------------+--------------------------------+-----------------------------+
    |Seq 张量描述符相关接口                                                                                             |
    +----------------------------------------------------+--------------------------------+-----------------------------+
    |cnnlCreateSeqDataDescriptor                         |创建一个序列数据描述符          |无                           |
    +----------------------------------------------------+--------------------------------+-----------------------------+
    |cnnlSetSeqDataDescriptor                            |为一个序列数据描述符设置信息    |无                           |
    +----------------------------------------------------+--------------------------------+-----------------------------+
    |cnnlGetSeqDataDescriptor                            |获取一个序列数据描述符信息      |无                           |
    +----------------------------------------------------+--------------------------------+-----------------------------+
    |cnnlDestroySeqDataDescriptor                        |销毁一个序列数据描述符          |无                           |
    +----------------------------------------------------+--------------------------------+-----------------------------+
    |cnnlSetSeqDataDescriptorPositionAndScale            |为一个序列数据描述符设置量化参  |无                           |
    |                                                    |Position 以及 Scale             |                             |
    +----------------------------------------------------+--------------------------------+-----------------------------+
    |cnnlSetSeqDataDescriptorOnchipDataType              |为序列数据描述符设置片上数据类  |无                           |
    |                                                    |型                              |                             |
    +----------------------------------------------------+--------------------------------+-----------------------------+
    |cnnlGetSeqDataDescriptorOnchipDataType              |获取序列数据描述符的片上数据类  |无                           |
    |                                                    |型                              |                             |
    +----------------------------------------------------+--------------------------------+-----------------------------+
    |Set 张量描述符相关接口                                                                                             |
    +----------------------------------------------------+--------------------------------+-----------------------------+
    |cnnlCreateTensorSetDescriptor                       |创建一个张量描述符集合的描述符  |无                           |
    +----------------------------------------------------+--------------------------------+-----------------------------+
    |cnnlGetTensorSetDescriptor                          |获取一个张量描述符集合的描述符  |无                           |
    +----------------------------------------------------+--------------------------------+-----------------------------+
    |cnnlDestroyTensorSetDescriptor                      |销毁一个张量描述符集合的描述符  |无                           |
    +----------------------------------------------------+--------------------------------+-----------------------------+
    |cnnlInitTensorSetMemberDescriptor                   |为集合描述符中的一个张量成员描  |无                           |
    |                                                    |述符设置信息                    |                             |
    +----------------------------------------------------+--------------------------------+-----------------------------+
    |cnnlInitTensorSetMemberDescriptorPositionAndScale   |为集合描述符中的一个张量成员描  |无                           |
    |                                                    |述符设置信息                    |                             |
    +----------------------------------------------------+--------------------------------+-----------------------------+
    |cnnlGetTensorSetDescriptorSize                      |获取一个集合描述符中所有的张量  |无                           |
    |                                                    |描述符所描述的张量的尺寸总和    |                             |
    +----------------------------------------------------+--------------------------------+-----------------------------+
    |cnnlGetTensorAndDataFromTensorSet                   |获取集合描述符中的一个张量成员  |无                           |
    |                                                    |描述符以及该描述符所绑定张量数  |                             |
    |                                                    |据的硬件地址                    |                             |
    +----------------------------------------------------+--------------------------------+-----------------------------+

相关接口详情，参看《Cambricon CNNL Developer Guide》。

对于具有维度语义的张量，其形状的对应含义如下：

.. tabularcolumns:: |m{0.2\textwidth}|m{0.2\textwidth}|m{0.15\textwidth}|m{0.15\textwidth}|m{0.15\textwidth}|
.. table:: 张量形状的对应含义

    +--------------+-----------+----------+----------+----------+
    |N (batch size)|C (channel)|H (height)|W (width) |D (depth) |
    +==============+===========+==========+==========+==========+
    |batch size    |特征图数目 |图片高度  |图片宽度  |图片深度  |
    +--------------+-----------+----------+----------+----------+

NCHW，NHWC，HWCN等维度布局方式为4-D张量的数据布局方式，NDHWC与NCDHW为5-D数据布局方式。
用户可以通过指定支持张量的数据类型来进行不同精度的运算。使用 ``cnnlDataType_t`` 来定义数据类型。数据类型的含义如下表所示：

.. tabularcolumns:: |m{0.45\textwidth}|m{0.45\textwidth}|
.. table:: 数据类型的含义

  +------------------+----------------+
  |数据类型          |含义            |
  +==================+================+
  |CNNL_DATA_INVALID |无效数据类型    |
  +------------------+----------------+
  |CNNL_DATA_HALF    |HALF数据类型    |
  +------------------+----------------+
  |CNNL_DATA_FLOAT   |FLOAT数据类型   |
  +------------------+----------------+
  |CNNL_DATA_INT8    |INT8数据类型    |
  +------------------+----------------+
  |CNNL_DATA_INT16   |INT16数据类型   |
  +------------------+----------------+
  |CNNL_DATA_INT31   |INT31数据类型   |
  +------------------+----------------+
  |CNNL_DATA_INT32   |INT32数据类型   |
  +------------------+----------------+
  |CNNL_DATA_UINT8   |UINT8数据类型   |
  +------------------+----------------+
  |CNNL_DATA_BOOL    |BOOL数据类型    |
  +------------------+----------------+

