name: ci

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  test:
    runs-on: [self-hosted, mlu270-x5k]
    steps:
      - uses: actions/checkout@v2
      - name: build and test
        with:
          image: docker-user.extrotec.com:30080/cambricon/cnnl-ci:v0.4-ubuntu1604
          volumes: $(pwd):/work
          workdir: /work
          shell: /bin/bash
          run: |
            echo "Start build BANGC operators..."
            source env.sh
            cd bangc-ops
            ./build.sh
            cd ..
            echo "Start build BANGPy operators..."
            cd bangpy-ops/utils
            ./build_operators.sh
            cd ../..
            echo "Start test BANGC operators..."
            ./bangc-ops/build/test/mluop_gtest
            echo "Start test BANGPy operators..."
            ./bangpy-ops/utils/test_operators.sh --only_test --target=mlu270
            
