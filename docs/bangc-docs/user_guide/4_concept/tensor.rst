.. _tensor:

张量
========

张量，是指具有统一数据类型的多维数组。

张量描述符，描述所指向的张量具体信息的载体，包含张量数据的数据布局、数据类型、维度个数、维度大小、步长大小等信息。通过张量描述符的表征，每一块张量数据才得以具有实际的语义信息，进而可以用来表示图像、语音或视频等各领域的数据。

张量描述符的信息如下：

- 数据布局：表示没有维度语义的array，或者具有维度语义的布局，如NCHW、NHWC、HWCN、NDHWC和NCDHW。Cambricon BANGC OPS使用 ``mluOpTensorLayout_t`` 来描述数据布局。
- 数据类型：表示张量中数据的类型，如HALF、FLOAT、INT8和INT16等。Cambricon BANGC OPS使用 ``mluOpDataType_t`` 来描述数据类型。
- 维度个数：针对数据布局为array的张量，表示张量的维度，Cambricon BANGC OPS库支持1-8维。
- 维度大小：表示每个维度的大小。
- 步长大小：表示在同一个维度中访问两个相邻元素时需要走过的步数。例如，定义一个[3,4]的二维矩阵matrix，默认情况下其具有隐含的步长信息数组[4,1]，隐含着用户访问矩阵同维度内相邻元素需要间隔的元素个数信息，步长数组[4,1]的1表示访问第二个维度相邻元素时（例如matrix[2][1]和matrix[2][2]之间），内存上的间隔是0，也就是步长为1；访问第一个维度相邻元素时（例如matrix[1][1]和matrix[2][1]之间），内存上的间隔是3，也就是步长为4。用户可以在Cambricon BANGC OPS提供的张量描述符的相关接口中显示地、灵活地配置步长数组，来对真实张量数据进行灵活地操作。

每一个Cambricon BANGC OPS算子，维度大小一般是可变的，用户可以在调用对应接口之前通过 ``mluOpSetTensorDescriptor()`` 或 ``mluOpSetTensorDescriptorEx()`` 来设置张量信息。其中调用接口 ``mluOpSetTensorDescriptor()`` 时会自动设置张量的步长大小。如果要设置特殊的步长大小，可以调用 ``mluOpSetTensorDescriptorEx()`` 接口。另外，为了减少多次接口调用的时间开销，我们为用户提供了group接口 ``mluOpCreateGroupTensorDescriptors`` ， ``mluOpSetGroupTensorDescriptors`` 和 ``mluOpDestroyGroupTensorDescriptors`` ，用户可以在一次接口调用中完成一组张量描述符的创建、设置与销毁。详情查看《Cambricon BANGC OPS Developer Guide》。

Cambricon BANGC OPS函数库目前与张量描述符相关的接口有如下几个类别：

- 普通张量描述符相关接口：对张量描述符的普通操作，例如创建、设置、获取、销毁，重置以及设置片上数据类型、量化参数等信息。
- Group张量描述符相关接口：对一组张量描述符的普通操作，例如一组张量描述符的创建、设置和销毁。该接口旨在为同时大量创建、设置和销毁一组张量描述的使用场景提供简单易用、高性能的接口。通常来说，该接口的性能收益来自两部分：一、一次接口调用代替了原先的多次接口调用，减少了接口调用的开销；二、该接口内剔除了一些繁琐的检查操作，例如剔除了检查这一组描述符指针中是否有NULL，剔除了张量设置时候的最大维度限制检查。建议用户在保证功能正确开发后使用该组接口进行性能调优。

- Set张量描述符相关接口：对集合张量描述符的一系列操作，例如创建、设置和销毁，以及为集合中的一个张量描述符进行一系列的初始化、设置相关参数等操作。Set接口具有特有描述符 ``mluOpTensorSetDescriptor_t`` 。


.. tabularcolumns:: |m{0.60\textwidth}|m{0.2\textwidth}|m{0.10\textwidth}|
.. table:: 张量描述符相关接口
   :class: longtable

   +----------------------------------------------------+--------------------------------+-----------------------------+
   |接口名称                                            |接口功能                        |注意事项                     |
   +====================================================+================================+=============================+
   |普通张量描述符相关接口                                                                                             |
   +----------------------------------------------------+--------------------------------+-----------------------------+
   |mluOpCreateTensorDescriptor                         |创建一个张量描述符              |无                           |
   +----------------------------------------------------+--------------------------------+-----------------------------+
   |mluOpSetTensorDescriptor                            |为一个张量描述符设置信息        |position、scale、offset等不变|
   +----------------------------------------------------+--------------------------------+-----------------------------+
   |mluOpGetTensorDescriptor                            |获取一个张量描述符信息          |无                           |
   +----------------------------------------------------+--------------------------------+-----------------------------+
   |mluOpDestroyTensorDescriptor                        |销毁一个张量描述符              |无                           |
   +----------------------------------------------------+--------------------------------+-----------------------------+
   |mluOpResetTensorDescriptor                          |重置一个张量描述符的所有信息    |position、scale、offset等也会|
   |                                                    |                                |被重置                       |
   +----------------------------------------------------+--------------------------------+-----------------------------+
   |mluOpSetTensorDescriptorDim                         |为一个张量描述符设置信息        |无                           |
   +----------------------------------------------------+--------------------------------+-----------------------------+
   |mluOpSetTensorDescriptorEx                          |为一个张量描述符设置信息        |可以设置 stride 信息         |
   +----------------------------------------------------+--------------------------------+-----------------------------+
   |mluOpGetTensorDescriptorEx                          |获取一个张量描述符的信息        |可以获取 stride 信息         |
   +----------------------------------------------------+--------------------------------+-----------------------------+
   |mluOpSetTensorDescriptorOnchipDataType              |为一个张量描述符设置片上数据类  |无                           |
   |                                                    |型信息                          |                             |
   +----------------------------------------------------+--------------------------------+-----------------------------+
   |mluOpGetTensorDescriptorOnchipDataType              |获取一个张量描述符的片上数据类  |无                           |
   |                                                    |型信息                          |                             |
   +----------------------------------------------------+--------------------------------+-----------------------------+
   |mluOpSetTensorDescriptorPosition                    |为一个张量描述符设置量化参数    |无                           |
   |                                                    |position                        |                             |
   +----------------------------------------------------+--------------------------------+-----------------------------+
   |mluOpGetTensorDescriptorPosition                    |获取一个张量描述符的量化参数    |无                           |
   |                                                    |position                        |                             |
   +----------------------------------------------------+--------------------------------+-----------------------------+
   |mluOpSetTensorDescriptorPositionAndScale            |为一个张量描述符设置量化参数    |无                           |
   |                                                    |position 与 scale               |                             |
   +----------------------------------------------------+--------------------------------+-----------------------------+
   |mluOpGetTensorDescriptorPositionAndScale            |获取一个张量描述符的量化参数    |无                           |
   |                                                    |position 与 scale               |                             |
   +----------------------------------------------------+--------------------------------+-----------------------------+
   |mluOpSetTensorDescriptorPositionScaleAndOffset      |为一个张量描述符设置量化参数    |无                           |
   |                                                    |position，scale 与 offset       |                             |
   +----------------------------------------------------+--------------------------------+-----------------------------+
   |mluOpGetTensorDescriptorPositionScaleAndOffset      |获取一个张量描述符的量化参数    |无                           |
   |                                                    |position，scale 与 offset       |                             |
   +----------------------------------------------------+--------------------------------+-----------------------------+
   |Group 张量描述符相关接口                                                                                           |
   +----------------------------------------------------+--------------------------------+-----------------------------+
   |mluOpCreateGroupTensorDescriptors                   |创建一组张量描述符              |无                           |
   +----------------------------------------------------+--------------------------------+-----------------------------+
   |mluOpSetGroupTensorDescriptors                      |为一组张量描述符设置信息        |无                           |
   +----------------------------------------------------+--------------------------------+-----------------------------+
   |mluOpDestroyGroupTensorDescriptors                  |销毁一组张量描述符              |无                           |
   +----------------------------------------------------+--------------------------------+-----------------------------+
   |Set 张量描述符相关接口                                                                                             |
   +----------------------------------------------------+--------------------------------+-----------------------------+
   |mluOpCreateTensorSetDescriptor                      |创建一个张量描述符集合的描述符  |无                           |
   +----------------------------------------------------+--------------------------------+-----------------------------+
   |mluOpGetTensorSetDescriptor                         |获取一个张量描述符集合的描述符  |无                           |
   +----------------------------------------------------+--------------------------------+-----------------------------+
   |mluOpDestroyTensorSetDescriptor                     |销毁一个张量描述符集合的描述符  |无                           |
   +----------------------------------------------------+--------------------------------+-----------------------------+
   |mluOpInitTensorSetMemberDescriptor                  |为集合描述符中的一个张量成员描  |无                           |
   |                                                    |述符设置信息                    |                             |
   +----------------------------------------------------+--------------------------------+-----------------------------+
   |mluOpInitTensorSetMemberDescriptorPositionAndScale  |为集合描述符中的一个张量成员描  |无                           |
   |                                                    |述符设置信息                    |                             |
   +----------------------------------------------------+--------------------------------+-----------------------------+
   |mluOpGetTensorSetDescriptorSize                     |获取一个集合描述符中所有的张量  |无                           |
   |                                                    |描述符所描述的张量的尺寸总和    |                             |
   +----------------------------------------------------+--------------------------------+-----------------------------+
   |mluOpGetTensorAndDataFromTensorSet                  |获取集合描述符中的一个张量成员  |无                           |
   |                                                    |描述符以及该描述符所绑定张量数  |                             |
   |                                                    |据的硬件地址                    |                             |
   +----------------------------------------------------+--------------------------------+-----------------------------+
   
相关接口详情，请参见《Cambricon BANGC OPS Developer Guide》。

对于具有维度语义的张量，其形状的对应含义如下：

.. tabularcolumns:: |m{0.2\textwidth}|m{0.2\textwidth}|m{0.15\textwidth}|m{0.15\textwidth}|m{0.15\textwidth}|
.. table:: 张量形状的对应含义

    +---------------+------------+-----------+----------+----------+
    |N（batch size）|C（channel）|H（height）|W（width）|D（depth）|
    +===============+============+===========+==========+==========+
    |批量大小       |特征图数目  |图片高度   |图片宽度  |图片深度  |
    +---------------+------------+-----------+----------+----------+

NCHW、NHWC、HWCN等维度布局方式为4-D张量的数据布局方式，NDHWC与NCDHW为5D数据布局方式。
可以通过指定支持张量的数据类型来进行不同精度的运算。使用 ``mluOpDataType_t`` 来定义数据类型。数据类型的含义如下表所示：

.. tabularcolumns:: |m{0.45\textwidth}|m{0.45\textwidth}|
.. table:: 数据类型的含义

   +--------------------------+---------------------+
   |数据类型                  |含义                 |    
   +==========================+=====================+
   |MLUOP_DTYPE_INVALID       |无效数据类型         |
   +--------------------------+---------------------+
   |MLUOP_DTYPE_HALF          |HALF数据类型         |
   +--------------------------+---------------------+
   |MLUOP_DTYPE_FLOAT         |FLOAT数据类型        |
   +--------------------------+---------------------+
   |MLUOP_DTYPE_DOUBLE        |DOUBLE数据类型       |
   +--------------------------+---------------------+
   |MLUOP_DTYPE_INT8          |INT8数据类型         |
   +--------------------------+---------------------+
   |MLUOP_DTYPE_INT16         |INT16数据类型        |
   +--------------------------+---------------------+
   |MLUOP_DTYPE_INT32         |INT32数据类型        |
   +--------------------------+---------------------+
   |MLUOP_DTYPE_INT64         |INT64数据类型        |
   +--------------------------+---------------------+
   |MLUOP_DTYPE_UINT8         |UINT8数据类型        |
   +--------------------------+---------------------+
   |MLUOP_DTYPE_UINT16        |UINT16数据类型       |
   +--------------------------+---------------------+
   |MLUOP_DTYPE_UINT32        |UINT32数据类型       |
   +--------------------------+---------------------+
   |MLUOP_DTYPE_UINT64        |UINT64数据类型       |
   +--------------------------+---------------------+
   |MLUOP_DTYPE_BOOL          |BOOL数据类型         |
   +--------------------------+---------------------+
   |MLUOP_DTYPE_COMPLEX_HALF  |COMPLEX_HALF数据类型 |
   +--------------------------+---------------------+
   |MLUOP_DTYPE_COMPLEX_FLOAT |COMPLEX_FLOAT数据类型|
   +--------------------------+---------------------+

