name: ci

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  schedule:
    - cron: '0 15 * * *'

jobs:
  test:
    runs-on: [self-hosted, mlu270-x5k]
    steps:
      - uses: actions/checkout@v2
      - name: bangc_lint_check
        run: >
          docker run --rm -v $(pwd):/work -w /work docker-user.extrotec.com:30080/cair/open_cnnl_ubuntu16.04:v1.3 
          ./tools/pre-commit origin/master

      - name: build
        run: >
          docker run --rm -v $(pwd):/work -w /work docker-user.extrotec.com:30080/cair/open_cnnl_ubuntu16.04:v1.3 
          ./build.sh

      - name: test
        run: >
          idx=$(hostname | cut -d'-' -f3);docker run --rm --device /dev/cambricon_ctl --device /dev/cambricon_dev${idx}:/dev/cambricon_dev0 
          --device /dev/commu${idx}:/dev/commu0 -v $(pwd):/work -w /work docker-user.extrotec.com:30080/cair/open_cnnl_ubuntu16.04:v1.3 
          ./test.sh --target=mlu270

      - name: clean
        run: >
          docker run --rm -v $(pwd):/work -w /work docker-user.extrotec.com:30080/cair/open_cnnl_ubuntu16.04:v1.3 
          bash -c "rm -rf bangc-ops/build && rm -rf bangpy-ops/outs"
